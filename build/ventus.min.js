/**
 * Ventus
 * Copyright © 2012 Ramón Lamana
 * https://github.com/rlamana
 */

/**
 * almond 0.1.2 Copyright (c) 2011, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * Basejs
 * Copyright © 2009-2012 A. Matías Quezada
 * https://github.com/amatiasq
 */

(function(e,t){typeof define=="function"&&define.amd?define(["$","handlebars"],t):e.ventus=t(e.$,e.Handlebars)})(this,function(e,t){var n,r,i;return function(e){function c(e,t){var n=t&&t.split("/"),r=o.map,i=r&&r["*"]||{},s,u,a,f,l,c,h,p,d,v;if(e&&e.charAt(0)==="."&&t){n=n.slice(0,n.length-1),e=n.concat(e.split("/"));for(p=0;v=e[p];p++)if(v===".")e.splice(p,1),p-=1;else if(v===".."){if(p===1&&(e[2]===".."||e[0]===".."))return!0;p>0&&(e.splice(p-1,2),p-=2)}e=e.join("/")}if((n||i)&&r){s=e.split("/");for(p=s.length;p>0;p-=1){u=s.slice(0,p).join("/");if(n)for(d=n.length;d>0;d-=1){a=r[n.slice(0,d).join("/")];if(a){a=a[u];if(a){f=a,l=p;break}}}if(f)break;!c&&i&&i[u]&&(c=i[u],h=p)}!f&&c&&(f=c,l=h),f&&(s.splice(0,l,f),e=s.join("/"))}return e}function h(t,n){return function(){return l.apply(e,a.call(arguments,0).concat([t,n]))}}function p(e){return function(t){return c(t,e)}}function d(e){return function(n){t[e]=n}}function v(n){if(s.hasOwnProperty(n)){var r=s[n];delete s[n],u[n]=!0,f.apply(e,r)}if(!t.hasOwnProperty(n))throw new Error("No "+n);return t[n]}function m(e,t){var n,r,i=e.indexOf("!");return i!==-1?(n=c(e.slice(0,i),t),e=e.slice(i+1),r=v(n),r&&r.normalize?e=r.normalize(e,p(t)):e=c(e,t)):e=c(e,t),{f:n?n+"!"+e:e,n:e,p:r}}function g(e){return function(){return o&&o.config&&o.config[e]||{}}}var t={},s={},o={},u={},a=[].slice,f,l;f=function(n,r,i,o){var a=[],f,l,c,p,y,b;o=o||n;if(typeof i=="function"){r=!r.length&&i.length?["require","exports","module"]:r;for(b=0;b<r.length;b++){y=m(r[b],o),c=y.f;if(c==="require")a[b]=h(n);else if(c==="exports")a[b]=t[n]={},f=!0;else if(c==="module")l=a[b]={id:n,uri:"",exports:t[n],config:g(n)};else if(t.hasOwnProperty(c)||s.hasOwnProperty(c))a[b]=v(c);else if(y.p)y.p.load(y.n,h(o,!0),d(c),{}),a[b]=t[c];else if(!u[c])throw new Error(n+" missing "+c)}p=i.apply(t[n],a);if(n)if(l&&l.exports!==e&&l.exports!==t[n])t[n]=l.exports;else if(p!==e||!f)t[n]=p}else n&&(t[n]=i)},n=r=l=function(t,n,r,i){return typeof t=="string"?v(m(t,n).f):(t.splice||(o=t,n.splice?(t=n,n=r,r=null):t=e),n=n||function(){},i?f(e,t,n,r):setTimeout(function(){f(e,t,n,r)},15),l)},l.config=function(e){return o=e,l},i=function(e,t,n){t.splice||(n=t,t=[]),s[e]=[e,t,n]},i.amd={jQuery:!0}}(),i("../../vendor/almond",function(){}),function(e){function t(e,t,n){return function(r){return(r.funct===e&&r.scope===t)===n}}function n(){this._listeners={}}n.prototype={listenersCount:function(e){var t=this._listeners[e];return t?t.length:0},on:function(n,r,i){var s=this._listeners;s[n]||(s[n]=[]);if(s[n].some(t(r,i,!0)))return;s[n].push({funct:r,scope:i})},off:function(n,r,i){var s=this._listeners[n];if(!s)return;this._listeners[n]=s.filter(t(r,i,!1))},emit:function(t,n){var r=this._listeners[t];if(!r)return;var i=Array.prototype.slice.call(arguments,1);r.forEach(function(e){e.funct.apply(e.scope,i)})},connect:function(t,n){if(!t)return;for(var r in t){if(!t.hasOwnProperty(r))continue;this.on(r,t[r],n)}},disconnect:function(t,n){if(!t)return;for(var r in t){if(!t.hasOwnProperty(r))continue;this.off(r,t[r],n)}}},typeof Base=="function"&&(n=Base.extend(n.prototype)),typeof module!="undefined"&&module.exports?module.exports=n:typeof i!="undefined"&&i.amd?i("core/emitter",[],function(){return n}):e.Emitter=n}(this),i("core/view",["$"],function(e,t){var n=/^(?:(.*)\s)?(\w+)$/,r="transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",i="animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd",s=["transform","transition","animation","transform-origin"];for(var o=s.length;o--;)(function(t){e.cssHooks[t]={get:function(e,t,n){return null},set:function(e,n){e.style["-webkit-"+t]=n,e.style["-moz-"+t]=n,e.style["-ms-"+t]=n,e.style["-o-"+t]=n,e.style[t]=n}}})(s[o]);return e.fn.extend({listen:function(e,t){var r,i,s,o;for(var u in e){if(!e.hasOwnProperty(u))continue;r=e[u],i=u.match(n),s=i[1],o=i[2],o==="mousedown"?o+=" touchstart":o==="mousemove"?o+=" touchmove":o==="mouseup"?o+=" touchend":o==="click"&&(o+=" touchend"),typeof r=="string"&&(r=t[r]);if(!r)throw new Error("Handler not found");s?this.on(o,s,r.bind(t)):this.on(o,r.bind(t))}return this},onTransitionEnd:function(e,t){this.one(r,function(){e.apply(t||this)})},onAnimationEnd:function(e,t){this.one(i,function(){e.apply(t||this)})}}),function(t){return typeof t=="function"?function(n){return e(t(n||{}))}:e(t)}}),i("tpl",["require"],function(e){function n(e,n,r,i){n(["handlebars"],function(s){var o=e.replace(/^.*[\\\/]/,"")+t;if(i.isBuild){r();return}typeof i.debug=="undefined"||i.debug?n(["$"],function(i){i.get(n.toUrl(e)+t,{},function(e,t){r(s.compile(e))},"html")}):n([e+t],function(){r(s.templates[o])})})}var t=".tpl";return{load:n}}),i("less",[],function(){var e={options:{},load:function(t,n,i,s){var o;this.options=s.css;if(s.isBuild||!s.debug){i();return}r(["vendor/less"],function(){var e="less";t=n.toUrl(t).replace(/\.[^/.]+$/,"");var r=document.createElement("link");r.setAttribute("rel","stylesheet/less"),r.setAttribute("href",t+"."+e),less.sheets=[r],less.refresh(),i(r)})},write:function(t,n,e){}};return e}),i("wm/window",["core/emitter","core/view","tpl!../../tpl/window","less!../../css/window"],function(e,t,n){var r=function(r){this.signals=new e,r=r||{title:"Untitle Window",width:400,height:200,x:0,y:0,content:"",resizable:!0},this.el=t(n({title:r.title,classname:r.classname||""})),this.el.listen(this.events.window,this),this.$content=this.el.find(".wm-content"),r.content&&this.append(r.content),this.$header=this.el.find("header"),this.width=r.width||400,this.height=r.height||200,this.x=r.x||0,this.y=r.y||0,this.z=1e4,this.opened=!1,this.enabled=!0,this.active=!1,this.closed=!1,this.maximized=!1,this.minimized=!1,this.movable=!0,this.resizable=typeof r.resizable!="undefined"?r.resizable:!0};return r.prototype={_restore:null,_moving:null,_resizing:null,events:{window:{click:function(e){this.signals.emit("select",this,e)},mousedown:function(e){this.focus()},".wm-content click":function(e){this.enabled&&this.signals.emit("click",this,e)},".wm-window-title mousedown":function(e){if(!this.enabled||!this.movable)return;this._moving=this.toLocal({x:e.originalEvent.pageX,y:e.originalEvent.pageY}),this.el.addClass("move"),e.preventDefault()},".wm-window-title dblclick":function(e){this.enabled&&this.resizable&&this.maximize()},".wm-window-title button.wm-close click":function(e){e.stopPropagation(),e.preventDefault(),this.enabled&&this.close()},".wm-window-title button.wm-maximize click":function(e){e.stopPropagation(),e.preventDefault(),this.enabled&&this.resizable&&this.maximize()},".wm-window-title button.wm-minimize click":function(e){e.stopPropagation(),e.preventDefault(),this.enabled&&this.minimize()},".wm-window-title button mousedown":function(e){e.stopPropagation(),e.preventDefault()},"button.wm-resize mousedown":function(e){if(!this.enabled||!this.resizable)return;this._resizing={width:this.width-e.originalEvent.pageX,height:this.height-e.originalEvent.pageY},this.el.addClass("resizing"),e.preventDefault()}},space:{mousemove:function(e){this._moving&&this.move(e.originalEvent.pageX-this._moving.x,e.originalEvent.pageY-this._moving.y),this._resizing&&this.resize(e.originalEvent.pageX+this._resizing.width,e.originalEvent.pageY+this._resizing.height)},mouseup:function(e){this._moving&&(this.el.removeClass("move"),this._moving=null),this._resizing&&(this.el.removeClass("resizing"),this._restore=null,this._resizing=null)}}},set space(e){if(e&&!e.listen){console.error("The given space element is not a valid View");return}e.append(this.el),e.listen(this.events.space,this)},get maximized(){return this._maximized},set maximized(e){e?(this.stamp(),this.signals.emit("maximize",this)):this.signals.emit("restore",this),this._maximized=e},get minimized(){return this._minimized},set minimized(e){e?(this.stamp(),this.signals.emit("minimize",this)):this.signals.emit("restore",this),this._minimized=e},set active(e){e?(this.signals.emit("focus",this),this.el.addClass("active"),this.el.removeClass("inactive")):(this.signals.emit("blur",this),this.el.removeClass("active"),this.el.addClass("inactive")),this._active=e},get active(){return this._active},set enabled(e){e?this.el.removeClass("disabled"):this.el.addClass("disabled"),this._enabled=e},get enabled(){return this._enabled},set movable(e){this._movable=!!e},get movable(){return this._movable},set resizable(e){e?this.el.removeClass("noresizable"):this.el.addClass("noresizable"),this._resizable=!!e},get resizable(){return this._resizable},set closed(e){var t=this;e&&(this.signals.emit("close",this),this.el.addClass("closing"),this.el.onAnimationEnd(function(){this.el.removeClass("closing"),this.el.addClass("closed"),this.el.hide(),this.$content.html("")},this)),this._closed=e},get closed(){return this._closed},set opened(e){var t=this;e&&(this.signals.emit("open",this),this.el.show(),this.el.addClass("opening"),this.el.onAnimationEnd(function(){this.el.removeClass("opening")},this)),this._opened=e},get opened(){return this._opened},set width(e){this.el.width(e)},get width(){return parseInt(this.el.width())},set height(e){this.el.height(e)},get height(){return parseInt(this.el.height())},set x(e){this.el.css("left",e)},set y(e){this.el.css("top",e)},get x(){return parseInt(this.el.css("left"))},get y(){return parseInt(this.el.css("top"))},set z(e){this.el.css("z-index",e)},get z(){return parseInt(this.el.css("z-index"))},open:function(){return this.opened=!0,this},resize:function(e,t){return this.width=e,this.height=t,this},move:function(e,t){return this.x=e,this.y=t,this},stamp:function(){this.restore=function(){var e={width:this.width,height:this.height},t={x:this.x,y:this.y};return function(){return this.resize(e.width,e.height),this.move(t.x,t.y),this}}.apply(this)},restore:function(){},maximize:function(){return this.el.addClass("maximazing"),this.el.onTransitionEnd(function(){this.el.removeClass("maximazing")},this),this.maximized=!this.maximized,this},minimize:function(){return this.el.addClass("minimizing"),this.el.onTransitionEnd(function(){this.el.removeClass("minimizing")},this),this.minimized=!this.minimized,this},close:function(){return this.closed=!0,this},focus:function(){return this.active=!0,this},blur:function(){return this.active=!1,this},toLocal:function(e){return{x:e.x-this.x,y:e.y-this.y}},toGlobal:function(e){return{x:e.x+this.x,y:e.y+this.y}},append:function(e){e.appendTo(this.$content)}},r}),i("wm/modes/default",["less!../../../css/windowmanager"],function(){var e={register:function(){console.log("Default mode registered.")},plug:function(){},unplug:function(){},actions:{maximize:function(e){e.move(0,0),e.el.css("-webkit-transform","translate3d(0, 0, 0);"),e.resize(this.el.width(),this.el.height())},restore:function(e){e.restore()},minimize:function(e){e.resize(0,0)}}};return e}),i("wm/modes/expose",["less!../../../css/expose"],function(){var e={register:function(){var e=this;console.log("Expose mode registered."),this.el.on("contextmenu",function(t){return e.mode!=="expose"?e.mode="expose":e.mode==="expose"&&(e.mode="default"),!1})},plug:function(){var e=Math.floor,t=Math.ceil,n=this,r=t(this.windows.length/2),i=e(this.el.width()/r),s=e(this.el.height()/2),o,u,a,f;this.el.addClass("expose");for(var l,c,h=0,p=this.windows.length;h<p;h++)c=this.windows[h],c.stamp(),c.height>c.width?o=c.height>s?s/c.height:1:o=c.width>i?i/c.width:1,o-=.15,f={x:h%r*i,y:(h<r?0:1)*s},u=f.x+e((i-o*c.width)/2),a=f.y+e((s-o*c.height)/2),c.enabled=!1,c.movable=!1,c.el.addClass("exposing"),c.el.css("transform-origin","0 0"),c.el.css("transform","scale("+o+")"),c.el.css("top",a),c.el.css("left",u),c.el.onTransitionEnd(function(){c.el.removeClass("exposing")},this);this.overlay=!0,this.el.one("click",function(){n.mode="default"})},unplug:function(){var e=this.el;for(var t,n,r=this.windows.length;r--;){n=this.windows[r],n.restore(),n.el.css("transform","scale(1)"),n.el.css("transform-origin","50% 50%");var i=function(e){return function(){this.el.removeClass("expose"),e.el.css("transform","")}}(n);this.el.onTransitionEnd(i,this),n.movable=!0,n.enabled=!0}this.overlay=!1},actions:{focus:function(e){},close:function(){this.mode="expose"},select:function(e,t){this.mode="default",e.focus()}}};return e}),i("wm/modes/fullscreen",["less!../../../css/fullscreen"],function(){var e={register:function(){var e=this;console.log("Fullscreen mode registered.")},plug:function(){this.el.addClass("fullscreen");for(var e,t=0,n=this.windows.length;t<n;t++)e=this.windows[t],e.move(0,0),e.el.css("-webkit-transform","translate3d(0, 0, 0);"),e.resize(this.el.width(),this.el.height())},unplug:function(){var e=this.el;for(var t,n,r=this.windows.length;r--;){n=this.windows[r],n.restore(),n.el.css("transform","scale(1)"),n.el.css("transform-origin","50% 50%");var i=function(e){return function(){this.el.removeClass("fullscreen"),e.el.css("transform","")}}(n);this.el.onTransitionEnd(i,this),n.movable=!0,n.resizable=!0,n.enabled=!0}this.overlay=!1},actions:{focus:function(e){},close:function(){this.mode="expose"},select:function(e,t){this.mode="default",e.focus()}}};return e}),i("wm/windowmanager",["$","wm/window","core/view","wm/modes/default","wm/modes/expose","wm/modes/fullscreen"],function(e,t,n,r,i,s){var o=function(){this.el=n("<div class='wm-space'><div class='wm-overlay' /></div>"),e(document.body).prepend(this.el),this.$overlay=this.el.find(".wm-overlay"),this.$overlay.css("z-index",this._baseZ-1),this.actions.forEach(function(e){this[e]=function(e){return function(){this.currentMode.actions[e]&&this.currentMode.actions[e].apply(this,arguments)}}.call(this,e)},this);for(var t in this.modes)this.modes.hasOwnProperty(t)&&this.modes[t].register&&this.modes[t].register.apply(this);this.windows=[],this.active=null,this.mode="default",this.createWindow.fromQuery=this.createWindow.fromQuery.bind(this),this.createWindow.fromElement=this.createWindow.fromElement.bind(this)};return o.prototype={actions:["focus","blur","close","maximize","minimize","restore","select"],modes:{"default":r,expose:i,fullscreen:s},set mode(e){var t=this.modes[e];if(!t||this._mode===e)return;this._mode&&this.currentMode.unplug&&this.currentMode.unplug.apply(this),t.plug&&t.plug.apply(this),this._mode=e},get mode(){return this._mode},get currentMode(){return this.modes[this._mode]},set overlay(e){this.$overlay.css("opacity",e?.8:0),this._overlay=e},get overlay(){return this._overlay},createWindow:function(e){var n=new t(e);return this.mode="default",n.signals.on("focus",this._focus,this),n.signals.on("blur",this._blur,this),n.signals.on("close",this._close,this),this.actions.forEach(function(e){n.signals.on(e,this[e],this)},this),this.windows.push(n),n.space=this.el,n.focus(),n},_focus:function(e){var t,n=1e4,r=n+1e4,i;if(this.active&&this.active===e)return;this.active?(t=this.active.z,this.active.blur()):t=n,i=this.windows.indexOf(e),this.windows.splice(i,1),this.windows.push(e),e.z=t+1;if(t>r+this.windows.length)for(var s,o=this.windows.length;o--;)s=this.windows[o].z,this.windows[o].z=n+(s-r);this.active=e},_blur:function(e){this.active===e&&(this.active=null)},_close:function(e){var t=this.windows.indexOf(e),n;if(t===-1){console.log("Trying to close a window that doesn't exist in this window manager");return}this.windows.splice(t,1),n=this.windows.length,this.active&&this.active===e&&(this.active=n!==0?this.windows[n-1]:null,this.active&&this.active.focus())}},o.prototype.createWindow.fromQuery=function(e,t){return t.content=n(e),this.createWindow(t)},o.prototype.createWindow.fromElement=function(e,t){return t.content=n(e),this.createWindow(t)},o}),i("ventus",["require","wm/windowmanager","wm/window"],function(e){return{WindowManager:e("wm/windowmanager"),Window:e("wm/window")}}),i("$",function(){return e}),r("ventus")})